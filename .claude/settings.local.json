{
  "permissions": {
    "allow": [
      "Bash(dir:*)",
      "Bash(\"E:/github_work/tft-panel-fpga/.moai/specs/SPEC-001/spec.md\" << 'EOFMARKER'\n# SPEC-001: TFT Panel FPGA Controller Implementation\n\n## Meta Information\n\n| Field | Value |\n|-------|-------|\n| **Spec ID** | SPEC-001 |\n| **Title** | TFT Panel FPGA Controller - Full Implementation |\n| **Status** | Planning |\n| **Priority** | High |\n| **Created** | 2026-02-10 |\n| **Author** | MoAI Team |\n\n---\n\n## 1. Executive Summary\n\nImplement a complete FPGA controller for a-Si TFT Flat Panel Detector \\(R1717AS01.3\\) according to delivery package specifications.\n\n**Target FPGA**: Xilinx Artix-7 35T \\(xc7a35tcpg236-1\\)\n**Target Panel**: 2048 x 2048 a-Si TFT FPD\n\n---\n\n## 2. Requirements \\(EARS Format\\)\n\n### FR-1: Timing Generation Module\n**WHEN** the system is in active mode, **THE SYSTEM SHALL** generate sequential row/column timing signals.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-1.1 | Generate row addresses 0-2047 sequentially |\n| FR-1.2 | Generate column addresses for each row |\n| FR-1.3 | Provide row clock enable at 5 MHz +/- 1% |\n| FR-1.4 | Provide column clock enable at 10 MHz +/- 1% |\n| FR-1.5 | Support configurable integration time \\(1-65535 ms\\) |\n| FR-1.6 | Complete full frame readout within 250 ms |\n\n### FR-2: Bias Control Module\n**WHEN** MCU requests bias mode change, **THE SYSTEM SHALL** switch within 10 us.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-2.1 | Support NORMAL_BIAS \\(V_PD=-1.5V, V_COL=-1.0V\\) |\n| FR-2.2 | Support IDLE_LOW_BIAS \\(V_PD=-0.2V, V_COL=-0.2V\\) |\n| FR-2.3 | Support SLEEP_BIAS \\(V_PD=0V, V_COL=0V\\) |\n| FR-2.4 | Complete switching within 10 us |\n| FR-2.5 | Glitch-free transitions |\n| FR-2.6 | Report bias ready status |\n\n### FR-3: Data Acquisition Module\n**WHEN** reading panel data, **THE SYSTEM SHALL** buffer 14-bit ADC data.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-3.1 | Interface with 14-bit ADC |\n| FR-3.2 | Provide ADC clock up to 20 MHz |\n| FR-3.3 | Buffer in FIFO \\(2048 depth\\) |\n| FR-3.4 | Report FIFO status |\n| FR-3.5 | Support test pattern mode |\n\n### FR-4: Dummy Scan Engine Module\n**WHEN** in L2 idle mode, **THE SYSTEM SHALL** execute periodic dummy scan.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-4.1 | Configurable period \\(30-65535 sec\\) |\n| FR-4.2 | Reset all 2048 rows sequentially |\n| FR-4.3 | No ADC readout during dummy scan |\n| FR-4.4 | Complete within 2 ms |\n| FR-4.5 | Report dummy scan status |\n\n### FR-5: SPI Slave Interface Module\n**WHEN** MCU communicates via SPI, **THE SYSTEM SHALL** respond to commands.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-5.1 | Support SPI Mode 0 |\n| FR-5.2 | Operate up to 10 MHz |\n| FR-5.3 | Support 64 registers \\(0x00-0x3F\\) |\n| FR-5.4 | Support burst read |\n| FR-5.5 | 8-bit data width |\n\n### FR-6: Status and Interrupt Module\n**WHEN** events occur, **THE SYSTEM SHALL** report status and generate interrupts.\n\n| Sub-Requirement | Description |\n|----------------|-------------|\n| FR-6.1 | Report frame busy status |\n| FR-6.2 | Report FIFO status |\n| FR-6.3 | Generate frame complete interrupt |\n| FR-6.4 | Generate dummy scan complete interrupt |\n| FR-6.5 | Generate error interrupt |\n\n---\n\n## 3. Gap Analysis\n\n| Module | Current | Required | Gap |\n|--------|---------|----------|-----|\n| Top Module | 13 ports | 44 ports | Missing 31 ports |\n| SPI Slave | Working | Working | OK |\n| Register File | 8 regs | 64 regs | Missing 56 |\n| Timing Generator | None | FSM + clocks | Missing |\n| Bias Controller | Simple output | 3-mode FSM | Incomplete |\n| Dummy Scan Engine | None | Timer + sequencer | Missing |\n| ADC Controller | Placeholder | Full interface | Missing |\n| Testbenches | Skeleton | 90% coverage | Incomplete |\n\n---\n\n## 4. Implementation Phases\n\n### Phase 1: Foundation \\(Week 1\\)\n- 1.1 Expand register_file to 64 registers\n- 1.2 Update fpga_panel_controller to 44 ports\n- 1.3 Expand tb_top testbench\n\n### Phase 2: Timing Generation \\(Week 2\\)\n- 2.1 Implement timing_generator FSM\n- 2.2 Add clock dividers\n- 2.3 Create tb_timing_generator\n\n### Phase 3: Bias Control \\(Week 2\\)\n- 3.1 Implement bias_mux_controller FSM\n- 3.2 Add glitch-free output\n- 3.3 Create tb_bias_mux\n\n### Phase 4: Dummy Scan \\(Week 3\\)\n- 4.1 Implement dummy_scan_engine timer\n- 4.2 Add row reset sequencer\n- 4.3 Create tb_dummy_scan\n\n### Phase 5: Data Acquisition \\(Week 3-4\\)\n- 5.1 Implement adc_controller FSM\n- 5.2 Add FIFO \\(2048 depth\\)\n- 5.3 Create tb_adc_controller\n\n### Phase 6: Integration \\(Week 4\\)\n- 6.1 Full system test\n- 6.2 Synthesis\n- 6.3 Timing analysis\n- 6.4 Coverage report\n\n---\n\n## 5. Module Specifications\n\n### 5.1 Timing Generator\n\n```systemverilog\nmodule timing_generator \\(\n    input  logic clk_100mhz, rst_n,\n    input  logic frame_start, frame_reset,\n    input  logic [15:0] integration_time,\n    output logic frame_busy,\n    output logic [11:0] row_addr, col_addr,\n    output logic row_clk_en, col_clk_en,\n    output logic gate_sel, reset_pulse,\n    output logic adc_start_trigger\n\\);\n```\n\n**States**: IDLE -> RESET \\(10us\\) -> INTEGRATE \\(100ms\\) -> READOUT \\(102.4ms\\) -> IDLE\n\n### 5.2 Register Map \\(Full\\)\n\n| Addr | Name | Access | Reset | Description |\n|------|------|--------|-------|-------------|\n| 0x00 | CTRL_REG | RW | 0x00 | Control bits |\n| 0x01 | STATUS_REG | RO | 0x01 | Status flags |\n| 0x02 | BIAS_SELECT | RW | 0x00 | 00=NORMAL, 01=IDLE, 10=SLEEP |\n| 0x03-04 | DUMMY_PERIOD | RW | 0x003C | Period in seconds |\n| 0x05 | DUMMY_CONTROL | RW | 0x00 | Auto mode, trigger |\n| 0x06-09 | ROW_START/END | RW | 0/2047 | ROI rows |\n| 0x0A-0D | COL_START/END | RW | 0/2047 | ROI cols |\n| 0x0E-0F | INTEGRATION_TIME | RW | 0x0064 | Integration \\(ms\\) |\n| 0x10-13 | TIMING_CONFIG | RW | - | Clock dividers, mode |\n| 0x14-15 | INTERRUPT | RW/W1C | 0x00 | Mask/Status |\n| 0x16 | ERROR_CODE | RO | 0x00 | Error status |\n| 0x17 | FIRMWARE_VERSION | RO | 0x10 | Version 1.0 |\n| 0x20-3F | TEST_PATTERN | RW | 0x00 | 256 bytes |\n\n---\n\n## 6. Acceptance Criteria\n\n### Functional Tests\n- FT-001: SPI register read/write \\(64 registers\\)\n- FT-002: Frame capture < 250 ms\n- FT-003: Bias switching < 10 us\n- FT-004: Dummy scan 30-65535 sec\n- FT-005: FIFO no overflow/underflow\n- FT-006: All interrupts work\n\n### Performance\n- PT-001: Row clock 5 MHz +/- 1%\n- PT-002: Column clock 10 MHz +/- 1%\n- PT-003: Bias switch < 10 us\n- PT-004: SPI access < 2 us\n\n### Resource Budget\n| Resource | Target |\n|----------|--------|\n| Slice LUTs | < 15,000 \\(72%\\) |\n| Slice Registers | < 20,000 \\(48%\\) |\n| BRAMs | < 25 \\(25%\\) |\n| MMCM/PLL | <= 2 |\n\n---\n\n## 7. References\n\n- docs/delivery/00_project_overview.md\n- docs/delivery/01_requirements.md\n- docs/delivery/02_interfaces.md\n- docs/delivery/03_timing_specifications.md\n- docs/delivery/04_register_map.md\n- docs/delivery/05_acceptance_criteria.md\n\n---\n\n**End of SPEC-001**\nEOFMARKER)",
      "Bash(findstr:*)",
      "Bash(vsim:*)"
    ]
  },
  "enableAllProjectMcpServers": true,
  "enabledMcpjsonServers": [
    "context7",
    "sequential-thinking"
  ]
}
